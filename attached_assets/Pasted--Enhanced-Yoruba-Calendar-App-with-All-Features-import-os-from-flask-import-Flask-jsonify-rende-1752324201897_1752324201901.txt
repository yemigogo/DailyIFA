# Enhanced Yoruba Calendar App with All Features
import os
from flask import Flask, jsonify, render_template, redirect, url_for, request, flash
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user
from flask_migrate import Migrate
from flask_admin import Admin
from flask_admin.contrib.sqla import ModelView
from datetime import datetime, timedelta
import math
from werkzeug.security import generate_password_hash, check_password_hash
from flask_mail import Mail, Message
import requests
from push_notifications import PushNotifications

# Initialize Flask App
app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'dev-key-123')

# Configuration
app.config.update(
    MAIL_SERVER=os.getenv('MAIL_SERVER', 'smtp.example.com'),
    MAIL_PORT=os.getenv('MAIL_PORT', 587),
    MAIL_USE_TLS=True,
    MAIL_USERNAME=os.getenv('MAIL_USERNAME'),
    MAIL_PASSWORD=os.getenv('MAIL_PASSWORD'),
    PUSHER_APP_ID=os.getenv('PUSHER_APP_ID'),
    PUSHER_KEY=os.getenv('PUSHER_KEY'),
    PUSHER_SECRET=os.getenv('PUSHER_SECRET')
)

# Initialize Extensions
db = SQLAlchemy(app)
migrate = Migrate(app, db)
mail = Mail(app)
pn = PushNotifications(
    instance_id=os.getenv('PUSHER_INSTANCE_ID'),
    secret_key=os.getenv('PUSHER_SECRET_KEY')
)

# Admin Setup
admin = Admin(app, name='Od√∫n Admin', template_mode='bootstrap3')

# Login Manager
login_manager = LoginManager()
login_manager.login_view = 'login'
login_manager.init_app(app)

# ======================
# MODELS
# ======================

class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True)
    email = db.Column(db.String(120), unique=True)
    password_hash = db.Column(db.String(128))
    is_admin = db.Column(db.Boolean, default=False)
    notifications = db.relationship('Notification', backref='user', lazy=True)
    rituals = db.relationship('UserRitual', backref='author', lazy=True)
    devices = db.relationship('Device', backref='user', lazy=True)

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class UserRitual(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    date = db.Column(db.String(10))
    notes = db.Column(db.Text)
    completed = db.Column(db.Boolean, default=False)

class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    message = db.Column(db.Text)
    read = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Device(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    token = db.Column(db.String(255))
    platform = db.Column(db.String(50))

class ImportantDate(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    description = db.Column(db.Text)
    month = db.Column(db.Integer)
    day = db.Column(db.Integer)
    repeat_yearly = db.Column(db.Boolean, default=True)

# Admin Views
class AdminModelView(ModelView):
    def is_accessible(self):
        return current_user.is_authenticated and current_user.is_admin

admin.add_view(AdminModelView(User, db.session))
admin.add_view(AdminModelView(UserRitual, db.session))
admin.add_view(AdminModelView(Notification, db.session))
admin.add_view(AdminModelView(Device, db.session))
admin.add_view(AdminModelView(ImportantDate, db.session))

# ======================
# COMPLETE 13-MONTH DATA
# ======================

yoruba_months = [...]  # (Same as previous implementation)

# ==================
# NOTIFICATION SYSTEM
# ==================

def send_email_notification(user, subject, message):
    msg = Message(
        subject,
        sender='noreply@odun-calendar.com',
        recipients=[user.email]
    )
    msg.body = message
    mail.send(msg)

def send_push_notification(user, title, message):
    for device in user.devices:
        pn.publish(
            interests=[f"user_{user.id}"],
            publish_body={
                'apns': {
                    'aps': {
                        'alert': {
                            'title': title,
                            'body': message
                        }
                    }
                },
                'fcm': {
                    'notification': {
                        'title': title,
                        'body': message
                    }
                }
            }
        )

def check_important_dates():
    today = datetime.now()
    important_dates = ImportantDate.query.filter(
        db.or_(
            db.and_(
                ImportantDate.month == today.month,
                ImportantDate.day == today.day
            ),
            db.and_(
                ImportantDate.month == (today.month % 13) + 1,
                ImportantDate.day == today.day,
                ImportantDate.repeat_yearly == True
            )
        )
    ).all()

    for date in important_dates:
        users = User.query.all()
        for user in users:
            # Email notification
            send_email_notification(
                user,
                f"Important Date: {date.name}",
                f"Today is {date.name} in the Yoruba calendar.\n\n{date.description}"
            )
            
            # Push notification
            send_push_notification(
                user,
                f"üóìÔ∏è {date.name}",
                date.description[:100] + "..."
            )
            
            # In-app notification
            notification = Notification(
                user_id=user.id,
                message=f"Today is {date.name}: {date.description[:200]}"
            )
            db.session.add(notification)
    
    db.session.commit()

# ==================
# SOCIAL SHARING
# ==================

def get_social_share_links(date_info):
    text = f"Today is {date_info['yoruba_day']} in {date_info['month']} month of the Yoruba calendar. {date_info['activity']}"
    encoded_text = requests.utils.quote(text)
    return {
        'twitter': f"https://twitter.com/intent/tweet?text={encoded_text}&url=https://odun-calendar.com",
        'facebook': f"https://www.facebook.com/sharer/sharer.php?u=https://odun-calendar.com&quote={encoded_text}",
        'whatsapp': f"https://wa.me/?text={encoded_text}"
    }

# ==================
# SCHEDULED TASKS
# ==================

from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()
scheduler.add_job(
    func=check_important_dates,
    trigger='cron',
    hour=8,
    minute=0
)
scheduler.start()

# ==================
# ROUTES (Same as before with additions)
# ==================

@app.route('/share', methods=['POST'])
@login_required
def share():
    platform = request.form.get('platform')
    date_info = get_current_date_info()
    share_links = get_social_share_links(date_info)
    
    if platform in share_links:
        return redirect(share_links[platform])
    return redirect(url_for('dashboard'))

@app.route('/register_device', methods=['POST'])
@login_required
def register_device():
    token = request.form.get('token')
    platform = request.form.get('platform')
    
    device = Device.query.filter_by(user_id=current_user.id, token=token).first()
    if not device:
        device = Device(user_id=current_user.id, token=token, platform=platform)
        db.session.add(device)
        db.session.commit()
    
    return jsonify({'status': 'success'})

# ... (Other routes remain the same)

# ==================
# INITIALIZATION
# ==================

@app.before_first_request
def initialize_data():
    db.create_all()
    
    # Create admin user if none exists
    if not User.query.filter_by(is_admin=True).first():
        admin = User(
            username='admin',
            email='admin@odun-calendar.com',
            is_admin=True
        )
        admin.set_password('admin123')
        db.session.add(admin)
        
        # Add sample important dates
        important_dates = [
            ('·ªåb√†t√°l√° Day', 'Day of purification and new beginnings', 1, 1),
            ('√íg√∫n Festival', 'Celebration of iron and technology', 2, 15),
            # ... other important dates
        ]
        
        for name, desc, month, day in important_dates:
            date = ImportantDate(
                name=name,
                description=desc,
                month=month,
                day=day
            )
            db.session.add(date)
        
        db.session.commit()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)