<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>If√° Layered Audio Experience</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 1s ease-in-out;
            color: white;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
            pointer-events: none;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #f59e0b;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .audio-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #f59e0b;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.5);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
        }
        
        select option {
            background: #1e293b;
            color: white;
        }
        
        .play-button {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .play-button:hover {
            background: linear-gradient(45deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }
        
        .audio-player {
            width: 100%;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .prayer-text {
            background: rgba(245, 158, 11, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            margin: 20px 0;
            font-style: italic;
        }
        
        .yoruba {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .translation {
            font-size: 0.95em;
            opacity: 0.8;
            line-height: 1.5;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #f59e0b;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(245, 158, 11, 0.1);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to If√° Daily Reading</a>
        
        <h1>üéµ If√° Layered Audio Experience</h1>
        
        <div class="prayer-text">
            <div class="yoruba">
                <strong>Or√≠ mi d√° mi l√≥r√≠,</strong><br>
                <strong>·ªåÃÄrunm√¨l√†, j·ªçÃÄw·ªçÃÅ d√° mi l√≥r√≠.</strong><br>
                <strong>Mo b·∫πÃÄ If√°,</strong><br>
                <strong>K√≠ ·ªçj·ªçÃÅ mi d√°a l√≥n√¨√≠.</strong><br><br>
                
                <strong>Or√≠ ire, gb√† mi l'·ªçÃÅj·ªçÃÅ rere.</strong><br>
                <strong>·ªåÃÄ·π£un, al√°r√≤y√®, f√∫n mi n√≠ √†·π£·∫π √†t·ªçÃÅk√†nw√°.</strong><br>
                <strong>If√°, fi √†y·ªçÃÄ b√≥ mi l√°rug·∫π.</strong><br>
                <strong>·ªåd√∫n y√¨√≠ ni mo m√°a r√≠ √¨b√πk√∫n.</strong>
            </div>
            <div class="translation">
                <em>My head blesses me,<br>
                ·ªåÃÄrunm√¨l√†, please guide me.<br>
                I call on If√°,<br>
                That my day be good today.</em><br><br>
                
                <em>Good head, carry me into a blessed day.<br>
                ·ªåÃÄ·π£un, bringer of wealth, grant me divine favor.<br>
                If√°, wrap me in joy and success.<br>
                This year, I will walk in blessings.</em>
            </div>
        </div>
        
        <div class="audio-controls">
            <div class="control-group">
                <label for="layer1Select">üéµ Layer 1 (Chant/Drum)</label>
                <select id="layer1Select">
                    <option value="ifa_wisdom_chant">If√° Wisdom Chant</option>
                    <option value="ifa_prosperity_chant">If√° Prosperity Chant</option>
                    <option value="talking_drum_loop">Talking Drum</option>
                    <option value="bata_egungun_abida">Bat√° Drum ‚Äì Egungun Ceremony</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="layer2Select">üåä Layer 2 (Nature Ambience)</label>
                <select id="layer2Select">
                    <option value="ocean_blessing_waves">Ocean Blessing Waves</option>
                    <option value="sacred_forest">Sacred Forest</option>
                    <option value="flowing_river">Flowing River</option>
                    <option value="temple_peace">Temple Peace</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="orikiSelect">üëë Layer 3 (Optional Or√≠k√¨ Overlay)</label>
                <select id="orikiSelect">
                    <option value="">None</option>
                    <option value="oriki_sango">Or√≠k√¨ ·π¢√†ng√≥</option>
                    <option value="oriki_orunmila">Or√≠k√¨ √ír√∫nm√¨l√†</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="bataOffset">‚è± Drum Sync Offset (sec):</label>
                <input type="number" id="bataOffset" value="0" step="0.1" min="0" max="5" style="width: 80px; padding: 5px; border-radius: 4px; border: 1px solid rgba(245, 158, 11, 0.3);" />
            </div>
            
            <div class="control-group">
                <label for="sleepMinutes">‚è≤Ô∏è Sleep Timer (minutes):</label>
                <input type="number" id="sleepMinutes" min="1" max="120" style="width: 80px; padding: 5px; border-radius: 4px; border: 1px solid rgba(245, 158, 11, 0.3);" />
                <button onclick="setSleepTimer()" style="margin-left: 10px; padding: 5px 10px; background: #374151; color: white; border: none; border-radius: 4px;">Set Timer</button>
                <span id="timerStatus" style="margin-left: 10px; color: #22c55e; font-size: 0.9em;"></span>
            </div>
            
            <div class="control-group">
                <label for="intensitySlider">‚ö° Spiritual Energy Intensity:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="intensitySlider" min="0" max="100" value="50" 
                           style="flex: 1; height: 6px; background: linear-gradient(to right, #3b82f6, #8b5cf6, #ef4444); border-radius: 3px;" 
                           oninput="updateIntensityDisplay()" />
                    <span id="intensityValue" style="color: #f59e0b; font-weight: bold; min-width: 60px;">50% - Balanced</span>
                </div>
                <div style="display: flex; justify-between; font-size: 0.8em; color: #9ca3af; margin-top: 5px;">
                    <span>Meditative</span>
                    <span>Balanced</span>
                    <span>Ecstatic</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>üé≠ Sacred Preset Combinations:</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <button onclick="loadPreset('ancestral')" style="padding: 8px 12px; background: #7c3aed; color: white; border: none; border-radius: 4px; font-size: 0.85em;">üëª Ancestral</button>
                    <button onclick="loadPreset('healing')" style="padding: 8px 12px; background: #0ea5e9; color: white; border: none; border-radius: 4px; font-size: 0.85em;">üåä Healing</button>
                    <button onclick="loadPreset('prosperity')" style="padding: 8px 12px; background: #059669; color: white; border: none; border-radius: 4px; font-size: 0.85em;">üí∞ Prosperity</button>
                </div>
            </div>
        </div>
        
        <button class="play-button" onclick="playLayeredSound()">
            üéµ Play Layered Experience
        </button>
        <button onclick="stopAll()" style="margin-left: 10px; padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ‚èπ Stop All
        </button>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0;">
            <div>
                <label>Layer 1 Audio:</label>
                <audio id="layer1Audio" controls class="audio-player"></audio>
            </div>
            <div>
                <label>Layer 2 Audio:</label>
                <audio id="layer2Audio" controls class="audio-player"></audio>
            </div>
            <div>
                <label>Layer 3 Audio:</label>
                <audio id="orikiAudio" controls class="audio-player"></audio>
            </div>
        </div>
        
        <div id="nowPlaying" style="text-align: center; font-style: italic; color: #d97706; margin: 15px 0;"></div>
        
        <div id="infoPanel" style="background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0; display: none; border-left: 4px solid #f59e0b;">
            <h3 id="infoTitle" style="color: #f59e0b; margin-bottom: 10px; font-weight: bold;"></h3>
            <p><strong>Spiritual Role:</strong> <span id="infoRole"></span></p>
            <p><strong>Traditional Use:</strong> <span id="infoUse"></span></p>
            <p><strong>Energy Quality:</strong> <span id="infoEnergy"></span></p>
            <p><strong>Cultural Context:</strong> <span id="infoContext"></span></p>
        </div>
        
        <div class="status">
            <p>‚ú® Experience the spiritual harmony of traditional Yoruba chants combined with authentic soundscapes</p>
        </div>
    </div>

    <script>
        // Set spiritual background for audio demo
        document.addEventListener('DOMContentLoaded', function() {
            const spiritualBackgrounds = [
                '/static/images/backgrounds/temple_peace.jpg',
                '/static/images/backgrounds/forest_sacred.jpg'
            ];
            const randomBg = spiritualBackgrounds[Math.floor(Math.random() * spiritualBackgrounds.length)];
            document.body.style.backgroundImage = `url('${randomBg}')`;
        });

        const audioMap = {
            ifa_wisdom_chant: "/static/audio/soundscapes/ifa_wisdom_chant.mp3?v=" + Date.now(),
            ifa_prosperity_chant: "/static/audio/soundscapes/ifa_prosperity_chant.mp3?v=" + Date.now(),
            talking_drum_loop: "/static/audio/soundscapes/talking_drum_loop.mp3?v=" + Date.now(),
            bata_drums_loop: "/static/audio/soundscapes/bata_drums_loop.mp3?v=" + Date.now(),
            bata_egungun_abida: "/static/audio/soundscapes/bata_egungun_abida.mp3?v=" + Date.now(),
            flowing_river: "/static/audio/soundscapes/flowing_river.mp3?v=" + Date.now(),
            ocean_blessing_waves: "/static/audio/soundscapes/ocean_blessing_waves.mp3?v=" + Date.now(),
            sacred_forest: "/static/audio/soundscapes/sacred_forest.mp3?v=" + Date.now(),
            temple_peace: "/static/audio/soundscapes/temple_peace.mp3?v=" + Date.now(),
            sacred_ceremony: "/static/audio/soundscapes/sacred_ceremony.mp3?v=" + Date.now(),
            oriki_sango: "/static/audio/soundscapes/ifa_wisdom_chant.mp3?v=" + Date.now(),
            oriki_orunmila: "/static/audio/soundscapes/ifa_prosperity_chant.mp3?v=" + Date.now()
        };

        let bataPlayer = null;
        let oceanPlayer = null;

        function startBataLoop(volume = 0.8) {
            console.log("AUTHENTIC EGUNGUN BATA: startBataLoop called with volume:", volume);
            
            if (bataPlayer && !bataPlayer.paused) {
                console.log("Authentic Egungun Bata already playing");
                bataPlayer.volume = volume; // Update volume if already playing
                return;
            }
            
            console.log("Creating new AUTHENTIC EGUNGUN BATA player with path:", audioMap.bata_egungun_abida);
            bataPlayer = new Audio();
            bataPlayer.src = audioMap.bata_egungun_abida;
            bataPlayer.loop = true;
            bataPlayer.volume = volume;
            bataPlayer.preload = "auto";
            
            bataPlayer.addEventListener('loadstart', () => console.log("AUTHENTIC EGUNGUN BATA: loadstart"));
            bataPlayer.addEventListener('loadeddata', () => console.log("AUTHENTIC EGUNGUN BATA: loadeddata - duration:", bataPlayer.duration));
            bataPlayer.addEventListener('canplay', () => console.log("AUTHENTIC EGUNGUN BATA: canplay"));
            bataPlayer.addEventListener('canplaythrough', () => console.log("AUTHENTIC EGUNGUN BATA: canplaythrough"));
            bataPlayer.addEventListener('playing', () => console.log("SUCCESS: AUTHENTIC EGUNGUN BATA IS PLAYING!"));
            bataPlayer.addEventListener('error', (e) => {
                console.error("AUTHENTIC EGUNGUN BATA ERROR:", e);
                console.error("Error details:", e.target.error);
                console.error("Network state:", e.target.networkState);
                console.error("Ready state:", e.target.readyState);
            });
            
            console.log("Loading and playing AUTHENTIC EGUNGUN BATA...");
            bataPlayer.load();
            
            // Wait for some loading before attempting play
            setTimeout(() => {
                bataPlayer.play().then(() => {
                    console.log("CONFIRMED: Authentic Egungun Bata drums are playing!");
                }).catch(err => {
                    console.error("FAILED: Authentic Egungun Bata error:", err);
                    console.error("Error name:", err.name);
                    console.error("Error message:", err.message);
                });
            }, 100);
        }

        function stopBataLoop() {
            console.log("AUTHENTIC EGUNGUN BATA: stopBataLoop called");
            if (bataPlayer) {
                console.log("Stopping AUTHENTIC EGUNGUN BATA player");
                bataPlayer.pause();
                bataPlayer.currentTime = 0;
                bataPlayer = null;
            }
        }

        function startOceanLoop(volume = 0.5) {
            console.log("OCEAN BLESSING WAVES: startOceanLoop called with volume:", volume);
            if (oceanPlayer && !oceanPlayer.paused) {
                console.log("Ocean waves already playing");
                oceanPlayer.volume = volume; // Update volume if already playing
                return;        // already playing
            }
            
            console.log("Creating new OCEAN BLESSING WAVES player with path:", audioMap.ocean_blessing_waves);
            oceanPlayer = new Audio();
            oceanPlayer.src = audioMap.ocean_blessing_waves;
            oceanPlayer.loop = true;
            oceanPlayer.volume = volume;   // 0‚Äì1
            oceanPlayer.preload = "auto";
            
            oceanPlayer.addEventListener('loadstart', () => console.log("OCEAN BLESSING WAVES: loadstart"));
            oceanPlayer.addEventListener('loadeddata', () => console.log("OCEAN BLESSING WAVES: loadeddata - duration:", oceanPlayer.duration));
            oceanPlayer.addEventListener('canplay', () => console.log("OCEAN BLESSING WAVES: canplay"));
            oceanPlayer.addEventListener('canplaythrough', () => console.log("OCEAN BLESSING WAVES: canplaythrough"));
            oceanPlayer.addEventListener('playing', () => console.log("SUCCESS: OCEAN BLESSING WAVES IS PLAYING!"));
            oceanPlayer.addEventListener('error', (e) => {
                console.error("OCEAN WAVES ERROR:", e);
                console.error("Error details:", e.target.error);
                console.error("Network state:", e.target.networkState);
                console.error("Ready state:", e.target.readyState);
            });
            
            console.log("Loading and playing OCEAN BLESSING WAVES...");
            oceanPlayer.load();
            
            // Wait for some loading before attempting play
            setTimeout(() => {
                oceanPlayer.play().then(() => {
                    console.log("CONFIRMED: Ocean blessing waves are playing!");
                }).catch(err => {
                    console.error("Ocean audio error:", err);
                    console.error("Error name:", err.name);
                    console.error("Error message:", err.message);
                });
            }, 100);
        }

        function stopOceanLoop() {
            console.log("OCEAN BLESSING WAVES: stopOceanLoop called");
            if (oceanPlayer) {
                console.log("Stopping OCEAN BLESSING WAVES player");
                oceanPlayer.pause();
                oceanPlayer.currentTime = 0;
                oceanPlayer = null;
            }
        }

        function fadeInOcean(step = 0.05, interval = 100) {
            startOceanLoop(0);                          // start muted
            const id = setInterval(() => {
                if (oceanPlayer && oceanPlayer.volume < 0.5) {
                    oceanPlayer.volume += step;
                } else clearInterval(id);
            }, interval);
        }

        function fadeOutOcean(step = 0.05, interval = 100) {
            if (!oceanPlayer) return;
            const id = setInterval(() => {
                if (oceanPlayer && oceanPlayer.volume > step) {
                    oceanPlayer.volume -= step;
                } else {
                    clearInterval(id);
                    stopOceanLoop();
                }
            }, interval);
        }

        const soundDetails = {
            bata_egungun_abida: {
                title: "Bat√° Drum ‚Äì Egungun Ceremony",
                role: "Calls ancestral spirits in traditional Yoruba ceremonies",
                use: "Used in Egungun festivals and sacred processions",
                energy: "Deep, rhythmic, ceremonial grounding",
                note: "Your authentic 15MB Egungun Bata recording"
            },
            ifa_wisdom_chant: {
                title: "If√° Wisdom Chant",
                role: "Spiritual invocation of clarity and divine knowledge",
                use: "Recited during early morning prayer or divination",
                energy: "Reflective, uplifting, mentally awakening"
            },
            ifa_prosperity_chant: {
                title: "If√° Prosperity Chant",
                role: "Invocation for abundance and material blessings",
                use: "Chanted during wealth attraction rituals",
                energy: "Empowering, manifesting, abundant"
            },
            talking_drum_loop: {
                title: "Talking Drum",
                role: "Traditional communication and rhythm keeper",
                use: "Storytelling, ceremonies, and spiritual communication",
                energy: "Melodic, conversational, connecting"
            },
            ocean_blessing_waves: {
                title: "Ocean Blessing Waves",
                role: "Channeling Yemoja's maternal divine energy",
                use: "Healing ceremonies, emotional cleansing, fertility rituals",
                energy: "Nurturing, flowing, cleansing"
            },
            sacred_forest: {
                title: "Sacred Forest",
                role: "Connection to earth spirits and natural forces",
                use: "Meditation, herb gathering, nature-based healing",
                energy: "Grounding, mystical, peaceful",
                context: "The sacred groves where Orishas dwell and spiritual initiations take place"
            },
            flowing_river: {
                title: "Flowing River",
                role: "Channeling Oshun's flowing abundance energy",
                use: "Prosperity rituals, emotional flow, fertility ceremonies",
                energy: "Flowing, abundant, joyful",
                context: "The sacred waters of Oshun, goddess of rivers, love, and prosperity"
            },
            temple_peace: {
                title: "Temple Peace",
                role: "Creating sacred space for spiritual practice",
                use: "Meditation, prayer, spiritual preparation",
                energy: "Serene, sacred, contemplative",
                context: "The peaceful atmosphere of traditional Yoruba temples and shrines"
            }
        };

        // Preset combinations for sacred practices
        const presets = {
            ancestral: {
                layer1: "bata_egungun_abida",
                layer2: "sacred_forest",
                layer3: "",
                offset: 1.5,
                name: "Ancestral Communion"
            },
            healing: {
                layer1: "ifa_wisdom_chant",
                layer2: "ocean_blessing_waves", 
                layer3: "",
                offset: 0,
                name: "Divine Healing"
            },
            prosperity: {
                layer1: "ifa_prosperity_chant",
                layer2: "flowing_river",
                layer3: "",
                offset: 0,
                name: "Prosperity Ritual"
            }
        };

        const backgroundMap = {
            ifa_wisdom_chant: "/static/images/backgrounds/chant_background.jpg",
            ifa_prosperity_chant: "/static/images/backgrounds/prosperity_background.jpg",
            talking_drum_loop: "/static/images/backgrounds/drum_background.jpg",
            bata_drums_loop: "/static/images/backgrounds/drum_background.jpg",
            bata_egungun_abida: "/static/images/backgrounds/drum_background.jpg",
            ocean_blessing_waves: "/static/images/backgrounds/ocean_background.jpg",
            sacred_forest: "/static/images/backgrounds/chant_background.jpg",
            temple_peace: "/static/images/backgrounds/chant_background.jpg",
            sacred_ceremony: "/static/images/backgrounds/prosperity_background.jpg"
        };

        function setBackgroundImage(soundKey) {
            const imageUrl = backgroundMap[soundKey];
            if (imageUrl) {
                document.body.style.backgroundImage = `url('${imageUrl}')`;
            }
        }

        let sleepTimer = null;

        function playLayeredSound() {
            const l1 = document.getElementById("layer1Select").value;
            const l2 = document.getElementById("layer2Select").value;
            const l3 = document.getElementById("orikiSelect").value;
            const offset = parseFloat(document.getElementById("bataOffset").value || "0");
            const intensity = parseInt(document.getElementById("intensitySlider")?.value || "50");

            const a1 = document.getElementById("layer1Audio");
            const a2 = document.getElementById("layer2Audio");
            const a3 = document.getElementById("orikiAudio");

            // Set audio sources
            a1.src = audioMap[l1];
            a2.src = audioMap[l2];
            if (l3) a3.src = audioMap[l3];

            // Modulate volume levels based on intensity
            const intensityMultiplier = 0.3 + (intensity / 100) * 0.7; // 30% to 100% volume range
            a1.volume = 0.8 * intensityMultiplier;  // Primary layer
            a2.volume = 0.5 * intensityMultiplier;  // Background ambience
            if (l3) a3.volume = 0.6 * intensityMultiplier;  // Overlay

            // Set looping for continuous experience
            a2.loop = true;
            if (l3) a3.loop = true;

            // If the user picked Bat√°, use proper loop management
            if (l1 === "bata_egungun_abida") {
                console.log("User selected AUTHENTIC EGUNGUN BATA - starting loop");
                startBataLoop(0.8 * intensityMultiplier);
                // Don't play a1 to avoid duplication
            } else {
                console.log("User selected other sound, stopping Bata loop");
                stopBataLoop();
                a1.play().catch(e => console.log("Layer 1 failed:", e));
            }
            
            // Ocean control following user's exact pattern with smooth transitions
            const natureKey = l2;
            if (natureKey === "ocean_blessing_waves") {
                // Use fade-in for smooth ocean entrance
                fadeInOcean(0.05, 100);
                // Adjust final volume based on intensity
                setTimeout(() => {
                    if (oceanPlayer) {
                        oceanPlayer.volume = 0.5 * intensityMultiplier;
                    }
                }, 1000);
            } else {
                // Use fade-out for smooth ocean exit
                fadeOutOcean(0.05, 100);
            }
            
            // Handle other layer 2 sounds (non-ocean)
            if (l2 !== "ocean_blessing_waves" && l2.includes('bata') || l2.includes('drum')) {
                setTimeout(() => a2.play().catch(e => console.log("Layer 2 failed:", e)), offset * 1000);
            } else if (l2 !== "ocean_blessing_waves" && l2) {
                a2.play().catch(e => console.log("Layer 2 failed:", e));
            }
            
            if (l3) {
                setTimeout(() => a3.play().catch(e => console.log("Layer 3 failed:", e)), 2000);
            }

            // Update display
            setBackgroundImage(l1);
            showSoundInfo(l1);
            updateNowPlaying(l1, l2, l3, offset, intensity);
            
            // Update button
            const button = document.querySelector('.play-button');
            button.textContent = 'üéµ Playing Layered Experience...';
            button.style.background = 'linear-gradient(45deg, #22c55e, #16a34a)';
        }

        function showSoundInfo(soundKey) {
            const info = soundDetails[soundKey];
            if (info) {
                document.getElementById('infoTitle').textContent = info.title;
                document.getElementById('infoRole').textContent = info.role;
                document.getElementById('infoUse').textContent = info.use;
                document.getElementById('infoEnergy').textContent = info.energy;
                document.getElementById('infoContext').textContent = info.context || 'Traditional Yoruba spiritual practice';
                document.getElementById('infoPanel').style.display = 'block';
            }
        }

        function updateNowPlaying(l1, l2, l3, offset, intensity = 50) {
            let text = `üéµ Playing: ${l1} + ${l2}`;
            if (l3) text += ` + ${l3}`;
            if (offset > 0) text += ` (${offset}s offset)`;
            text += ` | Energy: ${intensity}%`;
            document.getElementById('nowPlaying').textContent = text;
        }

        function updateIntensityDisplay() {
            const intensity = document.getElementById('intensitySlider').value;
            const valueDisplay = document.getElementById('intensityValue');
            
            let description = "Balanced";
            if (intensity < 20) description = "Gentle";
            else if (intensity < 40) description = "Calm";
            else if (intensity < 60) description = "Balanced";
            else if (intensity < 80) description = "Dynamic";
            else description = "Powerful";
            
            valueDisplay.textContent = `${intensity}% - ${description}`;
            
            // Update slider gradient based on value
            const slider = document.getElementById('intensitySlider');
            const percentage = (intensity - slider.min) / (slider.max - slider.min) * 100;
            slider.style.background = `linear-gradient(to right, 
                #3b82f6 0%, 
                #8b5cf6 ${percentage}%, 
                #ef4444 100%)`;
        }

        function setSleepTimer() {
            const minutes = parseInt(document.getElementById('sleepMinutes').value);
            if (minutes && minutes > 0) {
                if (sleepTimer) clearTimeout(sleepTimer);
                
                sleepTimer = setTimeout(() => {
                    stopAll();
                    document.getElementById('nowPlaying').textContent = 'üò¥ Sleep timer activated - all audio stopped';
                    document.getElementById('timerStatus').textContent = '';
                }, minutes * 60 * 1000);
                
                document.getElementById('timerStatus').textContent = `Timer set for ${minutes} minutes`;
                setTimeout(() => {
                    if (document.getElementById('timerStatus').textContent.includes('Timer set')) {
                        document.getElementById('timerStatus').textContent = '';
                    }
                }, 3000);
            }
        }

        function loadPreset(presetName) {
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('layer1Select').value = preset.layer1;
                document.getElementById('layer2Select').value = preset.layer2;
                document.getElementById('orikiSelect').value = preset.layer3;
                document.getElementById('bataOffset').value = preset.offset;
                
                // Show preset info
                document.getElementById('nowPlaying').textContent = `üé≠ Loading ${preset.name} preset...`;
                
                // Auto-play the preset after brief delay
                setTimeout(() => {
                    playLayeredSound();
                }, 800);
            }
        }

        // Enhanced stop functionality
        function stopAll() {
            const a1 = document.getElementById("layer1Audio");
            const a2 = document.getElementById("layer2Audio");
            const a3 = document.getElementById("orikiAudio");
            
            [a1, a2, a3].forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            
            // Stop all specialized loops with smooth fade-out
            stopBataLoop();
            fadeOutOcean(0.1, 50);  // Faster fade-out when stopping all
            
            if (sleepTimer) {
                clearTimeout(sleepTimer);
                sleepTimer = null;
            }
            
            const button = document.querySelector('.play-button');
            button.textContent = 'üéµ Play Layered Experience';
            button.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)';
            
            document.getElementById('nowPlaying').textContent = '';
            document.getElementById('timerStatus').textContent = '';
            document.getElementById('infoPanel').style.display = 'none';
        }
        
        // Enhanced event listeners
        document.getElementById('layer1Select').addEventListener('change', function() {
            setBackgroundImage(this.value);
            showSoundInfo(this.value);
        });

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                playLayeredSound();
            }
            if (e.code === 'Escape') {
                stopAll();
            }
            if (e.code === 'KeyS' && e.ctrlKey) {
                e.preventDefault();
                setSleepTimer();
            }
        });

        // Test audio accessibility and initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Testing audio file accessibility...");
            
            // Test key audio files
            const testFiles = ['bata_egungun_abida', 'ocean_blessing_waves'];
            testFiles.forEach(file => {
                const audio = new Audio(audioMap[file]);
                audio.addEventListener('loadstart', () => console.log(`‚úì ${file}: accessible`));
                audio.addEventListener('error', (e) => console.error(`‚úó ${file}: error`, e.target.error));
                audio.load();
            });
            
            const firstSound = document.getElementById('layer1Select').value;
            showSoundInfo(firstSound);
            updateIntensityDisplay();
        });
    </script>
</body>
</html>